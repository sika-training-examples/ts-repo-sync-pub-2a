# Don't edit this file maually
# This file is generated by ./generate-gitlab-ci.yml

image: ondrejsika/ci

stages:
  - build_js_priority
  - build_docker_priority
  - deploy_dev_priority
  - deploy_prod_priority
  - build_js
  - build_docker
  - deploy_dev
  - deploy_prod

variables:
  DOCKER_BUILDKIT: '1'

ansible-schulung.de build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/ansible-schulung.de/out
    - yarn run static-ansible-schulung.de
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ansible-schulung.de/**/*
      - yarn.lock
  artifacts:
    name: ansible-schulung.de
    paths:
      - packages/ansible-schulung.de/out


ansible-schulung.de build docker:
  dependencies:
    - ansible-schulung.de build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/ansible-schulung.de/
    - docker build -t registry.sikahq.com/www/www/ansible-schulung.de:$CI_COMMIT_SHORT_SHA packages/ansible-schulung.de
    - rm packages/ansible-schulung.de/Dockerfile
    - rm packages/ansible-schulung.de/nginx-site.conf
    - docker push registry.sikahq.com/www/www/ansible-schulung.de:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ansible-schulung.de/**/*
      - yarn.lock

ansible-schulung.de prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install ansible-schulung-de ondrejsika/one-image --set host=ansible-schulung.de --set image=$CI_REGISTRY_IMAGE/ansible-schulung.de:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy ansible-schulung-de
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ansible-schulung.de/**/*
      - yarn.lock
  environment:
    name: prod ansible-schulung.de
    url: https://ansible-schulung.de
  dependencies: []

ansible-skoleni.cz build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/ansible-skoleni.cz/out
    - yarn run static-ansible-skoleni.cz
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ansible-skoleni.cz/**/*
      - yarn.lock
  artifacts:
    name: ansible-skoleni.cz
    paths:
      - packages/ansible-skoleni.cz/out


ansible-skoleni.cz build docker:
  dependencies:
    - ansible-skoleni.cz build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/ansible-skoleni.cz/
    - docker build -t registry.sikahq.com/www/www/ansible-skoleni.cz:$CI_COMMIT_SHORT_SHA packages/ansible-skoleni.cz
    - rm packages/ansible-skoleni.cz/Dockerfile
    - rm packages/ansible-skoleni.cz/nginx-site.conf
    - docker push registry.sikahq.com/www/www/ansible-skoleni.cz:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ansible-skoleni.cz/**/*
      - yarn.lock

ansible-skoleni.cz prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install ansible-skoleni-cz ondrejsika/one-image --set host=ansible-skoleni.cz --set image=$CI_REGISTRY_IMAGE/ansible-skoleni.cz:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy ansible-skoleni-cz
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ansible-skoleni.cz/**/*
      - yarn.lock
  environment:
    name: prod ansible-skoleni.cz
    url: https://ansible-skoleni.cz
  dependencies: []

archetype-web build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/archetype-web/out
    - yarn run static-archetype-web
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/archetype-web/**/*
      - yarn.lock
  artifacts:
    name: archetype-web
    paths:
      - packages/archetype-web/out


archetype-web build docker:
  dependencies:
    - archetype-web build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/archetype-web/
    - docker build -t registry.sikahq.com/www/www/archetype-web:$CI_COMMIT_SHORT_SHA packages/archetype-web
    - rm packages/archetype-web/Dockerfile
    - rm packages/archetype-web/nginx-site.conf
    - docker push registry.sikahq.com/www/www/archetype-web:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/archetype-web/**/*
      - yarn.lock

dockerschulung.de build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/dockerschulung.de/out
    - yarn run static-dockerschulung.de
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/dockerschulung.de/**/*
      - yarn.lock
  artifacts:
    name: dockerschulung.de
    paths:
      - packages/dockerschulung.de/out


dockerschulung.de build docker:
  dependencies:
    - dockerschulung.de build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/dockerschulung.de/
    - docker build -t registry.sikahq.com/www/www/dockerschulung.de:$CI_COMMIT_SHORT_SHA packages/dockerschulung.de
    - rm packages/dockerschulung.de/Dockerfile
    - rm packages/dockerschulung.de/nginx-site.conf
    - docker push registry.sikahq.com/www/www/dockerschulung.de:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/dockerschulung.de/**/*
      - yarn.lock

dockerschulung.de prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install dockerschulung-de ondrejsika/one-image --set host=dockerschulung.de --set image=$CI_REGISTRY_IMAGE/dockerschulung.de:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy dockerschulung-de
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/dockerschulung.de/**/*
      - yarn.lock
  environment:
    name: prod dockerschulung.de
    url: https://dockerschulung.de
  dependencies: []

gitlab-ci.cz build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/gitlab-ci.cz/out
    - yarn run static-gitlab-ci.cz
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/gitlab-ci.cz/**/*
      - yarn.lock
  artifacts:
    name: gitlab-ci.cz
    paths:
      - packages/gitlab-ci.cz/out


gitlab-ci.cz build docker:
  dependencies:
    - gitlab-ci.cz build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/gitlab-ci.cz/
    - docker build -t registry.sikahq.com/www/www/gitlab-ci.cz:$CI_COMMIT_SHORT_SHA packages/gitlab-ci.cz
    - rm packages/gitlab-ci.cz/Dockerfile
    - rm packages/gitlab-ci.cz/nginx-site.conf
    - docker push registry.sikahq.com/www/www/gitlab-ci.cz:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/gitlab-ci.cz/**/*
      - yarn.lock

gitlab-ci.cz prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install gitlab-ci-cz ondrejsika/one-image --set host=gitlab-ci.cz --set image=$CI_REGISTRY_IMAGE/gitlab-ci.cz:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy gitlab-ci-cz
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/gitlab-ci.cz/**/*
      - yarn.lock
  environment:
    name: prod gitlab-ci.cz
    url: https://gitlab-ci.cz
  dependencies: []

kubernetes-schulung.de build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/kubernetes-schulung.de/out
    - yarn run static-kubernetes-schulung.de
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/kubernetes-schulung.de/**/*
      - yarn.lock
  artifacts:
    name: kubernetes-schulung.de
    paths:
      - packages/kubernetes-schulung.de/out


kubernetes-schulung.de build docker:
  dependencies:
    - kubernetes-schulung.de build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/kubernetes-schulung.de/
    - docker build -t registry.sikahq.com/www/www/kubernetes-schulung.de:$CI_COMMIT_SHORT_SHA packages/kubernetes-schulung.de
    - rm packages/kubernetes-schulung.de/Dockerfile
    - rm packages/kubernetes-schulung.de/nginx-site.conf
    - docker push registry.sikahq.com/www/www/kubernetes-schulung.de:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/kubernetes-schulung.de/**/*
      - yarn.lock

kubernetes-schulung.de prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install kubernetes-schulung-de ondrejsika/one-image --set host=kubernetes-schulung.de --set image=$CI_REGISTRY_IMAGE/kubernetes-schulung.de:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy kubernetes-schulung-de
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/kubernetes-schulung.de/**/*
      - yarn.lock
  environment:
    name: prod kubernetes-schulung.de
    url: https://kubernetes-schulung.de
  dependencies: []

ondrej-sika.cz build js:
  stage: build_js_priority
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/ondrej-sika.cz/out
    - yarn run static-ondrej-sika.cz
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/ondrejsika-theme/**/*
      - packages/ondrej-sika.cz/**/*
      - yarn.lock
  artifacts:
    name: ondrej-sika.cz
    paths:
      - packages/ondrej-sika.cz/out


ondrej-sika.cz build docker:
  dependencies:
    - ondrej-sika.cz build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker_priority
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/ondrej-sika.cz/
    - docker build -t registry.sikahq.com/www/www/ondrej-sika.cz:$CI_COMMIT_SHORT_SHA packages/ondrej-sika.cz
    - rm packages/ondrej-sika.cz/Dockerfile
    - rm packages/ondrej-sika.cz/nginx-site.conf
    - docker push registry.sikahq.com/www/www/ondrej-sika.cz:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/ondrejsika-theme/**/*
      - packages/ondrej-sika.cz/**/*
      - yarn.lock

ondrej-sika.cz prod deploy k8s:
  stage: deploy_prod_priority
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install ondrej-sika-cz ondrejsika/one-image --set host=ondrej-sika.cz --set image=$CI_REGISTRY_IMAGE/ondrej-sika.cz:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy ondrej-sika-cz
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ondrej-sika.cz/**/*
      - yarn.lock
  environment:
    name: prod ondrej-sika.cz
    url: https://ondrej-sika.cz
  dependencies: []

sika-kraml.de build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/sika-kraml.de/out
    - yarn run static-sika-kraml.de
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/sika-kraml.de/**/*
      - yarn.lock
  artifacts:
    name: sika-kraml.de
    paths:
      - packages/sika-kraml.de/out


sika-kraml.de build docker:
  dependencies:
    - sika-kraml.de build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/sika-kraml.de/
    - docker build -t registry.sikahq.com/www/www/sika-kraml.de:$CI_COMMIT_SHORT_SHA packages/sika-kraml.de
    - rm packages/sika-kraml.de/Dockerfile
    - rm packages/sika-kraml.de/nginx-site.conf
    - docker push registry.sikahq.com/www/www/sika-kraml.de:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/sika-kraml.de/**/*
      - yarn.lock

sika-kraml.de prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install sika-kraml-de ondrejsika/one-image --set host=sika-kraml.de --set image=$CI_REGISTRY_IMAGE/sika-kraml.de:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy sika-kraml-de
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/sika-kraml.de/**/*
      - yarn.lock
  environment:
    name: prod sika-kraml.de
    url: https://sika-kraml.de
  dependencies: []

skoleni-docker.cz build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/skoleni-docker.cz/out
    - yarn run static-skoleni-docker.cz
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-docker.cz/**/*
      - yarn.lock
  artifacts:
    name: skoleni-docker.cz
    paths:
      - packages/skoleni-docker.cz/out


skoleni-docker.cz build docker:
  dependencies:
    - skoleni-docker.cz build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/skoleni-docker.cz/
    - docker build -t registry.sikahq.com/www/www/skoleni-docker.cz:$CI_COMMIT_SHORT_SHA packages/skoleni-docker.cz
    - rm packages/skoleni-docker.cz/Dockerfile
    - rm packages/skoleni-docker.cz/nginx-site.conf
    - docker push registry.sikahq.com/www/www/skoleni-docker.cz:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-docker.cz/**/*
      - yarn.lock

skoleni-docker.cz prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install skoleni-docker-cz ondrejsika/one-image --set host=skoleni-docker.cz --set image=$CI_REGISTRY_IMAGE/skoleni-docker.cz:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy skoleni-docker-cz
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-docker.cz/**/*
      - yarn.lock
  environment:
    name: prod skoleni-docker.cz
    url: https://skoleni-docker.cz
  dependencies: []

skoleni-git.cz build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/skoleni-git.cz/out
    - yarn run static-skoleni-git.cz
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-git.cz/**/*
      - yarn.lock
  artifacts:
    name: skoleni-git.cz
    paths:
      - packages/skoleni-git.cz/out


skoleni-git.cz build docker:
  dependencies:
    - skoleni-git.cz build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/skoleni-git.cz/
    - docker build -t registry.sikahq.com/www/www/skoleni-git.cz:$CI_COMMIT_SHORT_SHA packages/skoleni-git.cz
    - rm packages/skoleni-git.cz/Dockerfile
    - rm packages/skoleni-git.cz/nginx-site.conf
    - docker push registry.sikahq.com/www/www/skoleni-git.cz:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-git.cz/**/*
      - yarn.lock

skoleni-git.cz prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install skoleni-git-cz ondrejsika/one-image --set host=skoleni-git.cz --set image=$CI_REGISTRY_IMAGE/skoleni-git.cz:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy skoleni-git-cz
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-git.cz/**/*
      - yarn.lock
  environment:
    name: prod skoleni-git.cz
    url: https://skoleni-git.cz
  dependencies: []

skoleni-kubernetes.cz build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/skoleni-kubernetes.cz/out
    - yarn run static-skoleni-kubernetes.cz
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-kubernetes.cz/**/*
      - yarn.lock
  artifacts:
    name: skoleni-kubernetes.cz
    paths:
      - packages/skoleni-kubernetes.cz/out


skoleni-kubernetes.cz build docker:
  dependencies:
    - skoleni-kubernetes.cz build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/skoleni-kubernetes.cz/
    - docker build -t registry.sikahq.com/www/www/skoleni-kubernetes.cz:$CI_COMMIT_SHORT_SHA packages/skoleni-kubernetes.cz
    - rm packages/skoleni-kubernetes.cz/Dockerfile
    - rm packages/skoleni-kubernetes.cz/nginx-site.conf
    - docker push registry.sikahq.com/www/www/skoleni-kubernetes.cz:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-kubernetes.cz/**/*
      - yarn.lock

skoleni-kubernetes.cz prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install skoleni-kubernetes-cz ondrejsika/one-image --set host=skoleni-kubernetes.cz --set image=$CI_REGISTRY_IMAGE/skoleni-kubernetes.cz:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy skoleni-kubernetes-cz
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-kubernetes.cz/**/*
      - yarn.lock
  environment:
    name: prod skoleni-kubernetes.cz
    url: https://skoleni-kubernetes.cz
  dependencies: []

git-training.uk build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/git-training.uk/out
    - yarn run static-git-training.uk
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/git-training.uk/**/*
      - yarn.lock
  artifacts:
    name: git-training.uk
    paths:
      - packages/git-training.uk/out


git-training.uk build docker:
  dependencies:
    - git-training.uk build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/git-training.uk/
    - docker build -t registry.sikahq.com/www/www/git-training.uk:$CI_COMMIT_SHORT_SHA packages/git-training.uk
    - rm packages/git-training.uk/Dockerfile
    - rm packages/git-training.uk/nginx-site.conf
    - docker push registry.sikahq.com/www/www/git-training.uk:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/git-training.uk/**/*
      - yarn.lock

git-training.uk prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install git-training-uk ondrejsika/one-image --set host=git-training.uk --set image=$CI_REGISTRY_IMAGE/git-training.uk:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy git-training-uk
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/git-training.uk/**/*
      - yarn.lock
  environment:
    name: prod git-training.uk
    url: https://git-training.uk
  dependencies: []

docker-training.uk build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/docker-training.uk/out
    - yarn run static-docker-training.uk
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/docker-training.uk/**/*
      - yarn.lock
  artifacts:
    name: docker-training.uk
    paths:
      - packages/docker-training.uk/out


docker-training.uk build docker:
  dependencies:
    - docker-training.uk build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/docker-training.uk/
    - docker build -t registry.sikahq.com/www/www/docker-training.uk:$CI_COMMIT_SHORT_SHA packages/docker-training.uk
    - rm packages/docker-training.uk/Dockerfile
    - rm packages/docker-training.uk/nginx-site.conf
    - docker push registry.sikahq.com/www/www/docker-training.uk:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/docker-training.uk/**/*
      - yarn.lock

docker-training.uk prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install docker-training-uk ondrejsika/one-image --set host=docker-training.uk --set image=$CI_REGISTRY_IMAGE/docker-training.uk:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy docker-training-uk
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/docker-training.uk/**/*
      - yarn.lock
  environment:
    name: prod docker-training.uk
    url: https://docker-training.uk
  dependencies: []

kubernetes-training.uk build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/kubernetes-training.uk/out
    - yarn run static-kubernetes-training.uk
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/kubernetes-training.uk/**/*
      - yarn.lock
  artifacts:
    name: kubernetes-training.uk
    paths:
      - packages/kubernetes-training.uk/out


kubernetes-training.uk build docker:
  dependencies:
    - kubernetes-training.uk build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/kubernetes-training.uk/
    - docker build -t registry.sikahq.com/www/www/kubernetes-training.uk:$CI_COMMIT_SHORT_SHA packages/kubernetes-training.uk
    - rm packages/kubernetes-training.uk/Dockerfile
    - rm packages/kubernetes-training.uk/nginx-site.conf
    - docker push registry.sikahq.com/www/www/kubernetes-training.uk:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/kubernetes-training.uk/**/*
      - yarn.lock

kubernetes-training.uk prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install kubernetes-training-uk ondrejsika/one-image --set host=kubernetes-training.uk --set image=$CI_REGISTRY_IMAGE/kubernetes-training.uk:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy kubernetes-training-uk
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/kubernetes-training.uk/**/*
      - yarn.lock
  environment:
    name: prod kubernetes-training.uk
    url: https://kubernetes-training.uk
  dependencies: []

ansible-training.uk build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/ansible-training.uk/out
    - yarn run static-ansible-training.uk
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ansible-training.uk/**/*
      - yarn.lock
  artifacts:
    name: ansible-training.uk
    paths:
      - packages/ansible-training.uk/out


ansible-training.uk build docker:
  dependencies:
    - ansible-training.uk build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/ansible-training.uk/
    - docker build -t registry.sikahq.com/www/www/ansible-training.uk:$CI_COMMIT_SHORT_SHA packages/ansible-training.uk
    - rm packages/ansible-training.uk/Dockerfile
    - rm packages/ansible-training.uk/nginx-site.conf
    - docker push registry.sikahq.com/www/www/ansible-training.uk:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ansible-training.uk/**/*
      - yarn.lock

ansible-training.uk prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install ansible-training-uk ondrejsika/one-image --set host=ansible-training.uk --set image=$CI_REGISTRY_IMAGE/ansible-training.uk:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy ansible-training-uk
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ansible-training.uk/**/*
      - yarn.lock
  environment:
    name: prod ansible-training.uk
    url: https://ansible-training.uk
  dependencies: []

gitlab-training.uk build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/gitlab-training.uk/out
    - yarn run static-gitlab-training.uk
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/gitlab-training.uk/**/*
      - yarn.lock
  artifacts:
    name: gitlab-training.uk
    paths:
      - packages/gitlab-training.uk/out


gitlab-training.uk build docker:
  dependencies:
    - gitlab-training.uk build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/gitlab-training.uk/
    - docker build -t registry.sikahq.com/www/www/gitlab-training.uk:$CI_COMMIT_SHORT_SHA packages/gitlab-training.uk
    - rm packages/gitlab-training.uk/Dockerfile
    - rm packages/gitlab-training.uk/nginx-site.conf
    - docker push registry.sikahq.com/www/www/gitlab-training.uk:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/gitlab-training.uk/**/*
      - yarn.lock

gitlab-training.uk prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install gitlab-training-uk ondrejsika/one-image --set host=gitlab-training.uk --set image=$CI_REGISTRY_IMAGE/gitlab-training.uk:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy gitlab-training-uk
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/gitlab-training.uk/**/*
      - yarn.lock
  environment:
    name: prod gitlab-training.uk
    url: https://gitlab-training.uk
  dependencies: []

skolenie-git.sk build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/skolenie-git.sk/out
    - yarn run static-skolenie-git.sk
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skolenie-git.sk/**/*
      - yarn.lock
  artifacts:
    name: skolenie-git.sk
    paths:
      - packages/skolenie-git.sk/out


skolenie-git.sk build docker:
  dependencies:
    - skolenie-git.sk build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/skolenie-git.sk/
    - docker build -t registry.sikahq.com/www/www/skolenie-git.sk:$CI_COMMIT_SHORT_SHA packages/skolenie-git.sk
    - rm packages/skolenie-git.sk/Dockerfile
    - rm packages/skolenie-git.sk/nginx-site.conf
    - docker push registry.sikahq.com/www/www/skolenie-git.sk:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skolenie-git.sk/**/*
      - yarn.lock

skolenie-git.sk prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install skolenie-git-sk ondrejsika/one-image --set host=skolenie-git.sk --set image=$CI_REGISTRY_IMAGE/skolenie-git.sk:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy skolenie-git-sk
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skolenie-git.sk/**/*
      - yarn.lock
  environment:
    name: prod skolenie-git.sk
    url: https://skolenie-git.sk
  dependencies: []

skolenie-gitlab.sk build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/skolenie-gitlab.sk/out
    - yarn run static-skolenie-gitlab.sk
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skolenie-gitlab.sk/**/*
      - yarn.lock
  artifacts:
    name: skolenie-gitlab.sk
    paths:
      - packages/skolenie-gitlab.sk/out


skolenie-gitlab.sk build docker:
  dependencies:
    - skolenie-gitlab.sk build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/skolenie-gitlab.sk/
    - docker build -t registry.sikahq.com/www/www/skolenie-gitlab.sk:$CI_COMMIT_SHORT_SHA packages/skolenie-gitlab.sk
    - rm packages/skolenie-gitlab.sk/Dockerfile
    - rm packages/skolenie-gitlab.sk/nginx-site.conf
    - docker push registry.sikahq.com/www/www/skolenie-gitlab.sk:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skolenie-gitlab.sk/**/*
      - yarn.lock

skolenie-gitlab.sk prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install skolenie-gitlab-sk ondrejsika/one-image --set host=skolenie-gitlab.sk --set image=$CI_REGISTRY_IMAGE/skolenie-gitlab.sk:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy skolenie-gitlab-sk
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skolenie-gitlab.sk/**/*
      - yarn.lock
  environment:
    name: prod skolenie-gitlab.sk
    url: https://skolenie-gitlab.sk
  dependencies: []

skolenie-docker.sk build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/skolenie-docker.sk/out
    - yarn run static-skolenie-docker.sk
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skolenie-docker.sk/**/*
      - yarn.lock
  artifacts:
    name: skolenie-docker.sk
    paths:
      - packages/skolenie-docker.sk/out


skolenie-docker.sk build docker:
  dependencies:
    - skolenie-docker.sk build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/skolenie-docker.sk/
    - docker build -t registry.sikahq.com/www/www/skolenie-docker.sk:$CI_COMMIT_SHORT_SHA packages/skolenie-docker.sk
    - rm packages/skolenie-docker.sk/Dockerfile
    - rm packages/skolenie-docker.sk/nginx-site.conf
    - docker push registry.sikahq.com/www/www/skolenie-docker.sk:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skolenie-docker.sk/**/*
      - yarn.lock

skolenie-docker.sk prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install skolenie-docker-sk ondrejsika/one-image --set host=skolenie-docker.sk --set image=$CI_REGISTRY_IMAGE/skolenie-docker.sk:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy skolenie-docker-sk
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skolenie-docker.sk/**/*
      - yarn.lock
  environment:
    name: prod skolenie-docker.sk
    url: https://skolenie-docker.sk
  dependencies: []

skolenie.kubernetes.sk build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/skolenie.kubernetes.sk/out
    - yarn run static-skolenie.kubernetes.sk
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skolenie.kubernetes.sk/**/*
      - yarn.lock
  artifacts:
    name: skolenie.kubernetes.sk
    paths:
      - packages/skolenie.kubernetes.sk/out


skolenie.kubernetes.sk build docker:
  dependencies:
    - skolenie.kubernetes.sk build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/skolenie.kubernetes.sk/
    - docker build -t registry.sikahq.com/www/www/skolenie.kubernetes.sk:$CI_COMMIT_SHORT_SHA packages/skolenie.kubernetes.sk
    - rm packages/skolenie.kubernetes.sk/Dockerfile
    - rm packages/skolenie.kubernetes.sk/nginx-site.conf
    - docker push registry.sikahq.com/www/www/skolenie.kubernetes.sk:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skolenie.kubernetes.sk/**/*
      - yarn.lock

skolenie.kubernetes.sk prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install skolenie-kubernetes-sk ondrejsika/one-image --set host=skolenie.kubernetes.sk --set image=$CI_REGISTRY_IMAGE/skolenie.kubernetes.sk:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy skolenie-kubernetes-sk
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skolenie.kubernetes.sk/**/*
      - yarn.lock
  environment:
    name: prod skolenie.kubernetes.sk
    url: https://skolenie.kubernetes.sk
  dependencies: []

skolenie-ansible.sk build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/skolenie-ansible.sk/out
    - yarn run static-skolenie-ansible.sk
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skolenie-ansible.sk/**/*
      - yarn.lock
  artifacts:
    name: skolenie-ansible.sk
    paths:
      - packages/skolenie-ansible.sk/out


skolenie-ansible.sk build docker:
  dependencies:
    - skolenie-ansible.sk build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/skolenie-ansible.sk/
    - docker build -t registry.sikahq.com/www/www/skolenie-ansible.sk:$CI_COMMIT_SHORT_SHA packages/skolenie-ansible.sk
    - rm packages/skolenie-ansible.sk/Dockerfile
    - rm packages/skolenie-ansible.sk/nginx-site.conf
    - docker push registry.sikahq.com/www/www/skolenie-ansible.sk:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skolenie-ansible.sk/**/*
      - yarn.lock

skolenie-ansible.sk dev deploy k8s:
  stage: deploy_dev
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install skolenie-ansible-sk-dev ondrejsika/one-image --set host=skolenie-ansible.sk.panda.k8s.oxs.cz --set image=$CI_REGISTRY_IMAGE/skolenie-ansible.sk:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy skolenie-ansible-sk-dev
  except:
    - master
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_DEV
      - $EXCEPT_DEPLOY_DEV_K8S
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skolenie-ansible.sk/**/*
      - yarn.lock
  environment:
    name: dev skolenie-ansible.sk
    url: https://skolenie-ansible.sk.panda.k8s.oxs.cz
  dependencies: []

ansible-utbildning.se build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/ansible-utbildning.se/out
    - yarn run static-ansible-utbildning.se
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ansible-utbildning.se/**/*
      - yarn.lock
  artifacts:
    name: ansible-utbildning.se
    paths:
      - packages/ansible-utbildning.se/out


ansible-utbildning.se build docker:
  dependencies:
    - ansible-utbildning.se build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/ansible-utbildning.se/
    - docker build -t registry.sikahq.com/www/www/ansible-utbildning.se:$CI_COMMIT_SHORT_SHA packages/ansible-utbildning.se
    - rm packages/ansible-utbildning.se/Dockerfile
    - rm packages/ansible-utbildning.se/nginx-site.conf
    - docker push registry.sikahq.com/www/www/ansible-utbildning.se:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ansible-utbildning.se/**/*
      - yarn.lock

ansible-utbildning.se prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install ansible-utbildning-se ondrejsika/one-image --set host=ansible-utbildning.se --set image=$CI_REGISTRY_IMAGE/ansible-utbildning.se:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy ansible-utbildning-se
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ansible-utbildning.se/**/*
      - yarn.lock
  environment:
    name: prod ansible-utbildning.se
    url: https://ansible-utbildning.se
  dependencies: []

docker-utbildning.se build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/docker-utbildning.se/out
    - yarn run static-docker-utbildning.se
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/docker-utbildning.se/**/*
      - yarn.lock
  artifacts:
    name: docker-utbildning.se
    paths:
      - packages/docker-utbildning.se/out


docker-utbildning.se build docker:
  dependencies:
    - docker-utbildning.se build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/docker-utbildning.se/
    - docker build -t registry.sikahq.com/www/www/docker-utbildning.se:$CI_COMMIT_SHORT_SHA packages/docker-utbildning.se
    - rm packages/docker-utbildning.se/Dockerfile
    - rm packages/docker-utbildning.se/nginx-site.conf
    - docker push registry.sikahq.com/www/www/docker-utbildning.se:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/docker-utbildning.se/**/*
      - yarn.lock

docker-utbildning.se prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install docker-utbildning-se ondrejsika/one-image --set host=docker-utbildning.se --set image=$CI_REGISTRY_IMAGE/docker-utbildning.se:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy docker-utbildning-se
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/docker-utbildning.se/**/*
      - yarn.lock
  environment:
    name: prod docker-utbildning.se
    url: https://docker-utbildning.se
  dependencies: []

git-utbildning.se build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/git-utbildning.se/out
    - yarn run static-git-utbildning.se
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/git-utbildning.se/**/*
      - yarn.lock
  artifacts:
    name: git-utbildning.se
    paths:
      - packages/git-utbildning.se/out


git-utbildning.se build docker:
  dependencies:
    - git-utbildning.se build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/git-utbildning.se/
    - docker build -t registry.sikahq.com/www/www/git-utbildning.se:$CI_COMMIT_SHORT_SHA packages/git-utbildning.se
    - rm packages/git-utbildning.se/Dockerfile
    - rm packages/git-utbildning.se/nginx-site.conf
    - docker push registry.sikahq.com/www/www/git-utbildning.se:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/git-utbildning.se/**/*
      - yarn.lock

git-utbildning.se prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install git-utbildning-se ondrejsika/one-image --set host=git-utbildning.se --set image=$CI_REGISTRY_IMAGE/git-utbildning.se:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy git-utbildning-se
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/git-utbildning.se/**/*
      - yarn.lock
  environment:
    name: prod git-utbildning.se
    url: https://git-utbildning.se
  dependencies: []

gitlab-utbildning.se build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/gitlab-utbildning.se/out
    - yarn run static-gitlab-utbildning.se
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/gitlab-utbildning.se/**/*
      - yarn.lock
  artifacts:
    name: gitlab-utbildning.se
    paths:
      - packages/gitlab-utbildning.se/out


gitlab-utbildning.se build docker:
  dependencies:
    - gitlab-utbildning.se build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/gitlab-utbildning.se/
    - docker build -t registry.sikahq.com/www/www/gitlab-utbildning.se:$CI_COMMIT_SHORT_SHA packages/gitlab-utbildning.se
    - rm packages/gitlab-utbildning.se/Dockerfile
    - rm packages/gitlab-utbildning.se/nginx-site.conf
    - docker push registry.sikahq.com/www/www/gitlab-utbildning.se:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/gitlab-utbildning.se/**/*
      - yarn.lock

gitlab-utbildning.se prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install gitlab-utbildning-se ondrejsika/one-image --set host=gitlab-utbildning.se --set image=$CI_REGISTRY_IMAGE/gitlab-utbildning.se:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy gitlab-utbildning-se
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/gitlab-utbildning.se/**/*
      - yarn.lock
  environment:
    name: prod gitlab-utbildning.se
    url: https://gitlab-utbildning.se
  dependencies: []

kubernetes-utbildning.se build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/kubernetes-utbildning.se/out
    - yarn run static-kubernetes-utbildning.se
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/kubernetes-utbildning.se/**/*
      - yarn.lock
  artifacts:
    name: kubernetes-utbildning.se
    paths:
      - packages/kubernetes-utbildning.se/out


kubernetes-utbildning.se build docker:
  dependencies:
    - kubernetes-utbildning.se build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/kubernetes-utbildning.se/
    - docker build -t registry.sikahq.com/www/www/kubernetes-utbildning.se:$CI_COMMIT_SHORT_SHA packages/kubernetes-utbildning.se
    - rm packages/kubernetes-utbildning.se/Dockerfile
    - rm packages/kubernetes-utbildning.se/nginx-site.conf
    - docker push registry.sikahq.com/www/www/kubernetes-utbildning.se:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/kubernetes-utbildning.se/**/*
      - yarn.lock

kubernetes-utbildning.se prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install kubernetes-utbildning-se ondrejsika/one-image --set host=kubernetes-utbildning.se --set image=$CI_REGISTRY_IMAGE/kubernetes-utbildning.se:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy kubernetes-utbildning-se
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/kubernetes-utbildning.se/**/*
      - yarn.lock
  environment:
    name: prod kubernetes-utbildning.se
    url: https://kubernetes-utbildning.se
  dependencies: []

ondrej-sika.uk build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/ondrej-sika.uk/out
    - yarn run static-ondrej-sika.uk
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/ondrejsika-theme/**/*
      - packages/ondrej-sika.uk/**/*
      - yarn.lock
      - packages/ondrejsika-singlepage/**/*
  artifacts:
    name: ondrej-sika.uk
    paths:
      - packages/ondrej-sika.uk/out


ondrej-sika.uk build docker:
  dependencies:
    - ondrej-sika.uk build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/ondrej-sika.uk/
    - docker build -t registry.sikahq.com/www/www/ondrej-sika.uk:$CI_COMMIT_SHORT_SHA packages/ondrej-sika.uk
    - rm packages/ondrej-sika.uk/Dockerfile
    - rm packages/ondrej-sika.uk/nginx-site.conf
    - docker push registry.sikahq.com/www/www/ondrej-sika.uk:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/ondrejsika-theme/**/*
      - packages/ondrej-sika.uk/**/*
      - yarn.lock
      - packages/ondrejsika-singlepage/**/*

ondrej-sika.uk dev deploy k8s:
  stage: deploy_dev
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install ondrej-sika-uk-dev ondrejsika/one-image --set host=ondrej-sika.uk.panda.k8s.oxs.cz --set image=$CI_REGISTRY_IMAGE/ondrej-sika.uk:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy ondrej-sika-uk-dev
  except:
    - master
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_DEV
      - $EXCEPT_DEPLOY_DEV_K8S
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/ondrejsika-theme/**/*
      - packages/ondrej-sika.uk/**/*
      - yarn.lock
      - packages/ondrejsika-singlepage/**/*
  environment:
    name: dev ondrej-sika.uk
    url: https://ondrej-sika.uk.panda.k8s.oxs.cz
  dependencies: []

ondrej-sika.de build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/ondrej-sika.de/out
    - yarn run static-ondrej-sika.de
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/ondrejsika-theme/**/*
      - packages/ondrej-sika.de/**/*
      - yarn.lock
      - packages/ondrejsika-singlepage/**/*
  artifacts:
    name: ondrej-sika.de
    paths:
      - packages/ondrej-sika.de/out


ondrej-sika.de build docker:
  dependencies:
    - ondrej-sika.de build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/ondrej-sika.de/
    - docker build -t registry.sikahq.com/www/www/ondrej-sika.de:$CI_COMMIT_SHORT_SHA packages/ondrej-sika.de
    - rm packages/ondrej-sika.de/Dockerfile
    - rm packages/ondrej-sika.de/nginx-site.conf
    - docker push registry.sikahq.com/www/www/ondrej-sika.de:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/ondrejsika-theme/**/*
      - packages/ondrej-sika.de/**/*
      - yarn.lock
      - packages/ondrejsika-singlepage/**/*

ondrej-sika.de prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install ondrej-sika-de ondrejsika/one-image --set host=ondrej-sika.de --set image=$CI_REGISTRY_IMAGE/ondrej-sika.de:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy ondrej-sika-de
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ondrej-sika.de/**/*
      - yarn.lock
  environment:
    name: prod ondrej-sika.de
    url: https://ondrej-sika.de
  dependencies: []

ondrejsikalabs.com build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/ondrejsikalabs.com/out
    - yarn run static-ondrejsikalabs.com
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ondrejsikalabs.com/**/*
      - yarn.lock
  artifacts:
    name: ondrejsikalabs.com
    paths:
      - packages/ondrejsikalabs.com/out


ondrejsikalabs.com build docker:
  dependencies:
    - ondrejsikalabs.com build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/ondrejsikalabs.com/
    - docker build -t registry.sikahq.com/www/www/ondrejsikalabs.com:$CI_COMMIT_SHORT_SHA packages/ondrejsikalabs.com
    - rm packages/ondrejsikalabs.com/Dockerfile
    - rm packages/ondrejsikalabs.com/nginx-site.conf
    - docker push registry.sikahq.com/www/www/ondrejsikalabs.com:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ondrejsikalabs.com/**/*
      - yarn.lock

ondrejsikalabs.com prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install ondrejsikalabs-com ondrejsika/one-image --set host=ondrejsikalabs.com --set image=$CI_REGISTRY_IMAGE/ondrejsikalabs.com:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy ondrejsikalabs-com
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ondrejsikalabs.com/**/*
      - yarn.lock
  environment:
    name: prod ondrejsikalabs.com
    url: https://ondrejsikalabs.com
  dependencies: []

sika.io build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/sika.io/out
    - yarn run static-sika.io
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/sika.io/**/*
      - yarn.lock
  artifacts:
    name: sika.io
    paths:
      - packages/sika.io/out


sika.io build docker:
  dependencies:
    - sika.io build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/sika.io/
    - docker build -t registry.sikahq.com/www/www/sika.io:$CI_COMMIT_SHORT_SHA packages/sika.io
    - rm packages/sika.io/Dockerfile
    - rm packages/sika.io/nginx-site.conf
    - docker push registry.sikahq.com/www/www/sika.io:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/sika.io/**/*
      - yarn.lock

docker-training.de build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/docker-training.de/out
    - yarn run static-docker-training.de
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/docker-training.de/**/*
      - yarn.lock
  artifacts:
    name: docker-training.de
    paths:
      - packages/docker-training.de/out


docker-training.de build docker:
  dependencies:
    - docker-training.de build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/docker-training.de/
    - docker build -t registry.sikahq.com/www/www/docker-training.de:$CI_COMMIT_SHORT_SHA packages/docker-training.de
    - rm packages/docker-training.de/Dockerfile
    - rm packages/docker-training.de/nginx-site.conf
    - docker push registry.sikahq.com/www/www/docker-training.de:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/docker-training.de/**/*
      - yarn.lock

docker-training.de prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install docker-training-de ondrejsika/one-image --set host=docker-training.de --set image=$CI_REGISTRY_IMAGE/docker-training.de:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy docker-training-de
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/docker-training.de/**/*
      - yarn.lock
  environment:
    name: prod docker-training.de
    url: https://docker-training.de
  dependencies: []

docker-training.ch build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/docker-training.ch/out
    - yarn run static-docker-training.ch
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/docker-training.ch/**/*
      - yarn.lock
  artifacts:
    name: docker-training.ch
    paths:
      - packages/docker-training.ch/out


docker-training.ch build docker:
  dependencies:
    - docker-training.ch build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/docker-training.ch/
    - docker build -t registry.sikahq.com/www/www/docker-training.ch:$CI_COMMIT_SHORT_SHA packages/docker-training.ch
    - rm packages/docker-training.ch/Dockerfile
    - rm packages/docker-training.ch/nginx-site.conf
    - docker push registry.sikahq.com/www/www/docker-training.ch:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/docker-training.ch/**/*
      - yarn.lock

docker-training.ch prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install docker-training-ch ondrejsika/one-image --set host=docker-training.ch --set image=$CI_REGISTRY_IMAGE/docker-training.ch:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy docker-training-ch
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/docker-training.ch/**/*
      - yarn.lock
  environment:
    name: prod docker-training.ch
    url: https://docker-training.ch
  dependencies: []

docker-training.at build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/docker-training.at/out
    - yarn run static-docker-training.at
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/docker-training.at/**/*
      - yarn.lock
  artifacts:
    name: docker-training.at
    paths:
      - packages/docker-training.at/out


docker-training.at build docker:
  dependencies:
    - docker-training.at build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/docker-training.at/
    - docker build -t registry.sikahq.com/www/www/docker-training.at:$CI_COMMIT_SHORT_SHA packages/docker-training.at
    - rm packages/docker-training.at/Dockerfile
    - rm packages/docker-training.at/nginx-site.conf
    - docker push registry.sikahq.com/www/www/docker-training.at:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/docker-training.at/**/*
      - yarn.lock

docker-training.at prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install docker-training-at ondrejsika/one-image --set host=docker-training.at --set image=$CI_REGISTRY_IMAGE/docker-training.at:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy docker-training-at
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/docker-training.at/**/*
      - yarn.lock
  environment:
    name: prod docker-training.at
    url: https://docker-training.at
  dependencies: []

docker-training.nl build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/docker-training.nl/out
    - yarn run static-docker-training.nl
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/docker-training.nl/**/*
      - yarn.lock
  artifacts:
    name: docker-training.nl
    paths:
      - packages/docker-training.nl/out


docker-training.nl build docker:
  dependencies:
    - docker-training.nl build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/docker-training.nl/
    - docker build -t registry.sikahq.com/www/www/docker-training.nl:$CI_COMMIT_SHORT_SHA packages/docker-training.nl
    - rm packages/docker-training.nl/Dockerfile
    - rm packages/docker-training.nl/nginx-site.conf
    - docker push registry.sikahq.com/www/www/docker-training.nl:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/docker-training.nl/**/*
      - yarn.lock

docker-training.nl prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install docker-training-nl ondrejsika/one-image --set host=docker-training.nl --set image=$CI_REGISTRY_IMAGE/docker-training.nl:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy docker-training-nl
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/docker-training.nl/**/*
      - yarn.lock
  environment:
    name: prod docker-training.nl
    url: https://docker-training.nl
  dependencies: []

git-training.nl build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/git-training.nl/out
    - yarn run static-git-training.nl
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/git-training.nl/**/*
      - yarn.lock
  artifacts:
    name: git-training.nl
    paths:
      - packages/git-training.nl/out


git-training.nl build docker:
  dependencies:
    - git-training.nl build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/git-training.nl/
    - docker build -t registry.sikahq.com/www/www/git-training.nl:$CI_COMMIT_SHORT_SHA packages/git-training.nl
    - rm packages/git-training.nl/Dockerfile
    - rm packages/git-training.nl/nginx-site.conf
    - docker push registry.sikahq.com/www/www/git-training.nl:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/git-training.nl/**/*
      - yarn.lock

git-training.nl prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install git-training-nl ondrejsika/one-image --set host=git-training.nl --set image=$CI_REGISTRY_IMAGE/git-training.nl:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy git-training-nl
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/git-training.nl/**/*
      - yarn.lock
  environment:
    name: prod git-training.nl
    url: https://git-training.nl
  dependencies: []

bootstrap-web build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/bootstrap-web/out
    - yarn run static-bootstrap-web
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/bootstrap-web/**/*
      - yarn.lock
  artifacts:
    name: bootstrap-web
    paths:
      - packages/bootstrap-web/out


bootstrap-web build docker:
  dependencies:
    - bootstrap-web build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/bootstrap-web/
    - docker build -t registry.sikahq.com/www/www/bootstrap-web:$CI_COMMIT_SHORT_SHA packages/bootstrap-web
    - rm packages/bootstrap-web/Dockerfile
    - rm packages/bootstrap-web/nginx-site.conf
    - docker push registry.sikahq.com/www/www/bootstrap-web:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/bootstrap-web/**/*
      - yarn.lock

trainera.io build js:
  stage: build_js_priority
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/trainera.io/out
    - yarn run static-trainera.io
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/ondrejsika-theme/**/*
      - packages/trainera.io/**/*
      - yarn.lock
  artifacts:
    name: trainera.io
    paths:
      - packages/trainera.io/out


trainera.io build docker:
  dependencies:
    - trainera.io build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker_priority
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/trainera.io/
    - docker build -t registry.sikahq.com/www/www/trainera.io:$CI_COMMIT_SHORT_SHA packages/trainera.io
    - rm packages/trainera.io/Dockerfile
    - rm packages/trainera.io/nginx-site.conf
    - docker push registry.sikahq.com/www/www/trainera.io:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/ondrejsika-theme/**/*
      - packages/trainera.io/**/*
      - yarn.lock

trainera.io prod deploy k8s:
  stage: deploy_prod_priority
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install trainera-io ondrejsika/one-image --set host=trainera.io --set image=$CI_REGISTRY_IMAGE/trainera.io:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy trainera-io
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/trainera.io/**/*
      - yarn.lock
  environment:
    name: prod trainera.io
    url: https://trainera.io
  dependencies: []

salzburgdevops.com build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/salzburgdevops.com/out
    - yarn run static-salzburgdevops.com
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/salzburgdevops.com/**/*
      - yarn.lock
  artifacts:
    name: salzburgdevops.com
    paths:
      - packages/salzburgdevops.com/out


salzburgdevops.com build docker:
  dependencies:
    - salzburgdevops.com build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/salzburgdevops.com/
    - docker build -t registry.sikahq.com/www/www/salzburgdevops.com:$CI_COMMIT_SHORT_SHA packages/salzburgdevops.com
    - rm packages/salzburgdevops.com/Dockerfile
    - rm packages/salzburgdevops.com/nginx-site.conf
    - docker push registry.sikahq.com/www/www/salzburgdevops.com:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/salzburgdevops.com/**/*
      - yarn.lock

salzburgdevops.com prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install salzburgdevops-com ondrejsika/one-image --set host=salzburgdevops.com --set image=$CI_REGISTRY_IMAGE/salzburgdevops.com:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy salzburgdevops-com
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/salzburgdevops.com/**/*
      - yarn.lock
  environment:
    name: prod salzburgdevops.com
    url: https://salzburgdevops.com
  dependencies: []

training.kubernetes.is build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/training.kubernetes.is/out
    - yarn run static-training.kubernetes.is
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/training.kubernetes.is/**/*
      - yarn.lock
  artifacts:
    name: training.kubernetes.is
    paths:
      - packages/training.kubernetes.is/out


training.kubernetes.is build docker:
  dependencies:
    - training.kubernetes.is build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/training.kubernetes.is/
    - docker build -t registry.sikahq.com/www/www/training.kubernetes.is:$CI_COMMIT_SHORT_SHA packages/training.kubernetes.is
    - rm packages/training.kubernetes.is/Dockerfile
    - rm packages/training.kubernetes.is/nginx-site.conf
    - docker push registry.sikahq.com/www/www/training.kubernetes.is:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/training.kubernetes.is/**/*
      - yarn.lock

training.kubernetes.is prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install training-kubernetes-is ondrejsika/one-image --set host=training.kubernetes.is --set image=$CI_REGISTRY_IMAGE/training.kubernetes.is:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy training-kubernetes-is
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/training.kubernetes.is/**/*
      - yarn.lock
  environment:
    name: prod training.kubernetes.is
    url: https://training.kubernetes.is
  dependencies: []

training.kubernetes.lu build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/training.kubernetes.lu/out
    - yarn run static-training.kubernetes.lu
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/training.kubernetes.lu/**/*
      - yarn.lock
  artifacts:
    name: training.kubernetes.lu
    paths:
      - packages/training.kubernetes.lu/out


training.kubernetes.lu build docker:
  dependencies:
    - training.kubernetes.lu build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/training.kubernetes.lu/
    - docker build -t registry.sikahq.com/www/www/training.kubernetes.lu:$CI_COMMIT_SHORT_SHA packages/training.kubernetes.lu
    - rm packages/training.kubernetes.lu/Dockerfile
    - rm packages/training.kubernetes.lu/nginx-site.conf
    - docker push registry.sikahq.com/www/www/training.kubernetes.lu:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/training.kubernetes.lu/**/*
      - yarn.lock

training.kubernetes.lu prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install training-kubernetes-lu ondrejsika/one-image --set host=training.kubernetes.lu --set image=$CI_REGISTRY_IMAGE/training.kubernetes.lu:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy training-kubernetes-lu
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/training.kubernetes.lu/**/*
      - yarn.lock
  environment:
    name: prod training.kubernetes.lu
    url: https://training.kubernetes.lu
  dependencies: []

skoleni-terraform.cz build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/skoleni-terraform.cz/out
    - yarn run static-skoleni-terraform.cz
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-terraform.cz/**/*
      - yarn.lock
  artifacts:
    name: skoleni-terraform.cz
    paths:
      - packages/skoleni-terraform.cz/out


skoleni-terraform.cz build docker:
  dependencies:
    - skoleni-terraform.cz build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/skoleni-terraform.cz/
    - docker build -t registry.sikahq.com/www/www/skoleni-terraform.cz:$CI_COMMIT_SHORT_SHA packages/skoleni-terraform.cz
    - rm packages/skoleni-terraform.cz/Dockerfile
    - rm packages/skoleni-terraform.cz/nginx-site.conf
    - docker push registry.sikahq.com/www/www/skoleni-terraform.cz:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-terraform.cz/**/*
      - yarn.lock

skoleni-terraform.cz prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install skoleni-terraform-cz ondrejsika/one-image --set host=skoleni-terraform.cz --set image=$CI_REGISTRY_IMAGE/skoleni-terraform.cz:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy skoleni-terraform-cz
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-terraform.cz/**/*
      - yarn.lock
  environment:
    name: prod skoleni-terraform.cz
    url: https://skoleni-terraform.cz
  dependencies: []

sika-training.com build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/sika-training.com/out
    - yarn run static-sika-training.com
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/sika-training.com/**/*
      - yarn.lock
  artifacts:
    name: sika-training.com
    paths:
      - packages/sika-training.com/out


sika-training.com build docker:
  dependencies:
    - sika-training.com build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/sika-training.com/
    - docker build -t registry.sikahq.com/www/www/sika-training.com:$CI_COMMIT_SHORT_SHA packages/sika-training.com
    - rm packages/sika-training.com/Dockerfile
    - rm packages/sika-training.com/nginx-site.conf
    - docker push registry.sikahq.com/www/www/sika-training.com:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/sika-training.com/**/*
      - yarn.lock

sika-training.com prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install sika-training-com ondrejsika/one-image --set host=sika-training.com --set image=$CI_REGISTRY_IMAGE/sika-training.com:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy sika-training-com
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/sika-training.com/**/*
      - yarn.lock
  environment:
    name: prod sika-training.com
    url: https://sika-training.com
  dependencies: []

ondrej-sika.com build js:
  stage: build_js_priority
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/ondrej-sika.com/out
    - yarn run static-ondrej-sika.com
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/ondrejsika-theme/**/*
      - packages/ondrej-sika.com/**/*
      - yarn.lock
  artifacts:
    name: ondrej-sika.com
    paths:
      - packages/ondrej-sika.com/out


ondrej-sika.com build docker:
  dependencies:
    - ondrej-sika.com build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker_priority
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/ondrej-sika.com/
    - docker build -t registry.sikahq.com/www/www/ondrej-sika.com:$CI_COMMIT_SHORT_SHA packages/ondrej-sika.com
    - rm packages/ondrej-sika.com/Dockerfile
    - rm packages/ondrej-sika.com/nginx-site.conf
    - docker push registry.sikahq.com/www/www/ondrej-sika.com:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/ondrejsika-theme/**/*
      - packages/ondrej-sika.com/**/*
      - yarn.lock

ondrej-sika.com prod deploy k8s:
  stage: deploy_prod_priority
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install ondrej-sika-com ondrejsika/one-image --set host=ondrej-sika.com --set image=$CI_REGISTRY_IMAGE/ondrej-sika.com:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy ondrej-sika-com
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ondrej-sika.com/**/*
      - yarn.lock
  environment:
    name: prod ondrej-sika.com
    url: https://ondrej-sika.com
  dependencies: []

sikahq.com build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/sikahq.com/out
    - yarn run static-sikahq.com
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/sikahq.com/**/*
      - yarn.lock
  artifacts:
    name: sikahq.com
    paths:
      - packages/sikahq.com/out


sikahq.com build docker:
  dependencies:
    - sikahq.com build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/sikahq.com/
    - docker build -t registry.sikahq.com/www/www/sikahq.com:$CI_COMMIT_SHORT_SHA packages/sikahq.com
    - rm packages/sikahq.com/Dockerfile
    - rm packages/sikahq.com/nginx-site.conf
    - docker push registry.sikahq.com/www/www/sikahq.com:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/sikahq.com/**/*
      - yarn.lock

sikahq.com prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install sikahq-com ondrejsika/one-image --set host=sikahq.com --set image=$CI_REGISTRY_IMAGE/sikahq.com:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy sikahq-com
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/sikahq.com/**/*
      - yarn.lock
  environment:
    name: prod sikahq.com
    url: https://sikahq.com
  dependencies: []

ondrejsika.io build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/ondrejsika.io/out
    - yarn run static-ondrejsika.io
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ondrejsika.io/**/*
      - yarn.lock
  artifacts:
    name: ondrejsika.io
    paths:
      - packages/ondrejsika.io/out


ondrejsika.io build docker:
  dependencies:
    - ondrejsika.io build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/ondrejsika.io/
    - docker build -t registry.sikahq.com/www/www/ondrejsika.io:$CI_COMMIT_SHORT_SHA packages/ondrejsika.io
    - rm packages/ondrejsika.io/Dockerfile
    - rm packages/ondrejsika.io/nginx-site.conf
    - docker push registry.sikahq.com/www/www/ondrejsika.io:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ondrejsika.io/**/*
      - yarn.lock

ondrejsika.io dev deploy k8s:
  stage: deploy_dev
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install ondrejsika-io-dev ondrejsika/one-image --set host=ondrejsika.io.panda.k8s.oxs.cz --set image=$CI_REGISTRY_IMAGE/ondrejsika.io:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy ondrejsika-io-dev
  except:
    - master
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_DEV
      - $EXCEPT_DEPLOY_DEV_K8S
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ondrejsika.io/**/*
      - yarn.lock
  environment:
    name: dev ondrejsika.io
    url: https://ondrejsika.io.panda.k8s.oxs.cz
  dependencies: []

cal-api.sika.io build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/cal-api.sika.io/out
    - yarn run static-cal-api.sika.io
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/cal-api.sika.io/**/*
      - yarn.lock
  artifacts:
    name: cal-api.sika.io
    paths:
      - packages/cal-api.sika.io/out


cal-api.sika.io build docker:
  dependencies:
    - cal-api.sika.io build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/cal-api.sika.io/
    - docker build -t registry.sikahq.com/www/www/cal-api.sika.io:$CI_COMMIT_SHORT_SHA packages/cal-api.sika.io
    - rm packages/cal-api.sika.io/Dockerfile
    - rm packages/cal-api.sika.io/nginx-site.conf
    - docker push registry.sikahq.com/www/www/cal-api.sika.io:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/cal-api.sika.io/**/*
      - yarn.lock

cal-api.sika.io prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install cal-api-sika-io ondrejsika/one-image --set host=cal-api.sika.io --set image=$CI_REGISTRY_IMAGE/cal-api.sika.io:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy cal-api-sika-io
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/cal-api.sika.io/**/*
      - yarn.lock
  environment:
    name: prod cal-api.sika.io
    url: https://cal-api.sika.io
  dependencies: []

skoleni-proxmox.cz build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/skoleni-proxmox.cz/out
    - yarn run static-skoleni-proxmox.cz
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-proxmox.cz/**/*
      - yarn.lock
  artifacts:
    name: skoleni-proxmox.cz
    paths:
      - packages/skoleni-proxmox.cz/out


skoleni-proxmox.cz build docker:
  dependencies:
    - skoleni-proxmox.cz build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/skoleni-proxmox.cz/
    - docker build -t registry.sikahq.com/www/www/skoleni-proxmox.cz:$CI_COMMIT_SHORT_SHA packages/skoleni-proxmox.cz
    - rm packages/skoleni-proxmox.cz/Dockerfile
    - rm packages/skoleni-proxmox.cz/nginx-site.conf
    - docker push registry.sikahq.com/www/www/skoleni-proxmox.cz:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-proxmox.cz/**/*
      - yarn.lock

skoleni-proxmox.cz prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install skoleni-proxmox-cz ondrejsika/one-image --set host=skoleni-proxmox.cz --set image=$CI_REGISTRY_IMAGE/skoleni-proxmox.cz:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy skoleni-proxmox-cz
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-proxmox.cz/**/*
      - yarn.lock
  environment:
    name: prod skoleni-proxmox.cz
    url: https://skoleni-proxmox.cz
  dependencies: []

ydo.cz build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/ydo.cz/out
    - yarn run static-ydo.cz
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ydo.cz/**/*
      - yarn.lock
  artifacts:
    name: ydo.cz
    paths:
      - packages/ydo.cz/out


ydo.cz build docker:
  dependencies:
    - ydo.cz build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/ydo.cz/
    - docker build -t registry.sikahq.com/www/www/ydo.cz:$CI_COMMIT_SHORT_SHA packages/ydo.cz
    - rm packages/ydo.cz/Dockerfile
    - rm packages/ydo.cz/nginx-site.conf
    - docker push registry.sikahq.com/www/www/ydo.cz:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ydo.cz/**/*
      - yarn.lock

ydo.cz prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install ydo-cz ondrejsika/one-image --set host=ydo.cz --set image=$CI_REGISTRY_IMAGE/ydo.cz:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy ydo-cz
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ydo.cz/**/*
      - yarn.lock
  environment:
    name: prod ydo.cz
    url: https://ydo.cz
  dependencies: []

skoleni-prometheus.cz build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/skoleni-prometheus.cz/out
    - yarn run static-skoleni-prometheus.cz
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-prometheus.cz/**/*
      - yarn.lock
  artifacts:
    name: skoleni-prometheus.cz
    paths:
      - packages/skoleni-prometheus.cz/out


skoleni-prometheus.cz build docker:
  dependencies:
    - skoleni-prometheus.cz build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/skoleni-prometheus.cz/
    - docker build -t registry.sikahq.com/www/www/skoleni-prometheus.cz:$CI_COMMIT_SHORT_SHA packages/skoleni-prometheus.cz
    - rm packages/skoleni-prometheus.cz/Dockerfile
    - rm packages/skoleni-prometheus.cz/nginx-site.conf
    - docker push registry.sikahq.com/www/www/skoleni-prometheus.cz:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-prometheus.cz/**/*
      - yarn.lock

skoleni-prometheus.cz prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install skoleni-prometheus-cz ondrejsika/one-image --set host=skoleni-prometheus.cz --set image=$CI_REGISTRY_IMAGE/skoleni-prometheus.cz:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy skoleni-prometheus-cz
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-prometheus.cz/**/*
      - yarn.lock
  environment:
    name: prod skoleni-prometheus.cz
    url: https://skoleni-prometheus.cz
  dependencies: []

ccc.oxs.cz build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/ccc.oxs.cz/out
    - yarn run static-ccc.oxs.cz
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ccc.oxs.cz/**/*
      - yarn.lock
  artifacts:
    name: ccc.oxs.cz
    paths:
      - packages/ccc.oxs.cz/out


ccc.oxs.cz build docker:
  dependencies:
    - ccc.oxs.cz build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/ccc.oxs.cz/
    - docker build -t registry.sikahq.com/www/www/ccc.oxs.cz:$CI_COMMIT_SHORT_SHA packages/ccc.oxs.cz
    - rm packages/ccc.oxs.cz/Dockerfile
    - rm packages/ccc.oxs.cz/nginx-site.conf
    - docker push registry.sikahq.com/www/www/ccc.oxs.cz:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ccc.oxs.cz/**/*
      - yarn.lock

ccc.oxs.cz prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install ccc-oxs-cz ondrejsika/one-image --set host=ccc.oxs.cz --set image=$CI_REGISTRY_IMAGE/ccc.oxs.cz:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy ccc-oxs-cz
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ccc.oxs.cz/**/*
      - yarn.lock
  environment:
    name: prod ccc.oxs.cz
    url: https://ccc.oxs.cz
  dependencies: []

sika.work build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/sika.work/out
    - yarn run static-sika.work
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/sika.work/**/*
      - yarn.lock
  artifacts:
    name: sika.work
    paths:
      - packages/sika.work/out


sika.work build docker:
  dependencies:
    - sika.work build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/sika.work/
    - docker build -t registry.sikahq.com/www/www/sika.work:$CI_COMMIT_SHORT_SHA packages/sika.work
    - rm packages/sika.work/Dockerfile
    - rm packages/sika.work/nginx-site.conf
    - docker push registry.sikahq.com/www/www/sika.work:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/sika.work/**/*
      - yarn.lock

ydo.sh build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/ydo.sh/out
    - yarn run static-ydo.sh
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ydo.sh/**/*
      - yarn.lock
  artifacts:
    name: ydo.sh
    paths:
      - packages/ydo.sh/out


ydo.sh build docker:
  dependencies:
    - ydo.sh build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/ydo.sh/
    - docker build -t registry.sikahq.com/www/www/ydo.sh:$CI_COMMIT_SHORT_SHA packages/ydo.sh
    - rm packages/ydo.sh/Dockerfile
    - rm packages/ydo.sh/nginx-site.conf
    - docker push registry.sikahq.com/www/www/ydo.sh:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ydo.sh/**/*
      - yarn.lock

skoleni-rancher.cz build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/skoleni-rancher.cz/out
    - yarn run static-skoleni-rancher.cz
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-rancher.cz/**/*
      - yarn.lock
  artifacts:
    name: skoleni-rancher.cz
    paths:
      - packages/skoleni-rancher.cz/out


skoleni-rancher.cz build docker:
  dependencies:
    - skoleni-rancher.cz build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/skoleni-rancher.cz/
    - docker build -t registry.sikahq.com/www/www/skoleni-rancher.cz:$CI_COMMIT_SHORT_SHA packages/skoleni-rancher.cz
    - rm packages/skoleni-rancher.cz/Dockerfile
    - rm packages/skoleni-rancher.cz/nginx-site.conf
    - docker push registry.sikahq.com/www/www/skoleni-rancher.cz:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/training/sessions.yml
      - packages/data/training/recommendations/**/*
      - packages/data/training/recommendations/**/*
      - packages/data/training/pictures/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-rancher.cz/**/*
      - yarn.lock

skoleni-rancher.cz prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install skoleni-rancher-cz ondrejsika/one-image --set host=skoleni-rancher.cz --set image=$CI_REGISTRY_IMAGE/skoleni-rancher.cz:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy skoleni-rancher-cz
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni-rancher.cz/**/*
      - yarn.lock
  environment:
    name: prod skoleni-rancher.cz
    url: https://skoleni-rancher.cz
  dependencies: []

sika.blog build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/sika.blog/out
    - yarn run static-sika.blog
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/sika.blog/**/*
      - yarn.lock
  artifacts:
    name: sika.blog
    paths:
      - packages/sika.blog/out


sika.blog build docker:
  dependencies:
    - sika.blog build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/sika.blog/
    - docker build -t registry.sikahq.com/www/www/sika.blog:$CI_COMMIT_SHORT_SHA packages/sika.blog
    - rm packages/sika.blog/Dockerfile
    - rm packages/sika.blog/nginx-site.conf
    - docker push registry.sikahq.com/www/www/sika.blog:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/sika.blog/**/*
      - yarn.lock

sika.blog prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install sika-blog ondrejsika/one-image --set host=sika.blog --set image=$CI_REGISTRY_IMAGE/sika.blog:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy sika-blog
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/sika.blog/**/*
      - yarn.lock
  environment:
    name: prod sika.blog
    url: https://sika.blog
  dependencies: []

static.sika.io build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/static.sika.io/out
    - yarn run static-static.sika.io
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/static.sika.io/**/*
      - yarn.lock
  artifacts:
    name: static.sika.io
    paths:
      - packages/static.sika.io/out


static.sika.io build docker:
  dependencies:
    - static.sika.io build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/static.sika.io/
    - docker build -t registry.sikahq.com/www/www/static.sika.io:$CI_COMMIT_SHORT_SHA packages/static.sika.io
    - rm packages/static.sika.io/Dockerfile
    - rm packages/static.sika.io/nginx-site.conf
    - docker push registry.sikahq.com/www/www/static.sika.io:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/static.sika.io/**/*
      - yarn.lock

static.sika.io prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install static-sika-io ondrejsika/one-image --set host=static.sika.io --set image=$CI_REGISTRY_IMAGE/static.sika.io:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy static-sika-io
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/static.sika.io/**/*
      - yarn.lock
  environment:
    name: prod static.sika.io
    url: https://static.sika.io
  dependencies: []

ondrejsikaltd.com build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/ondrejsikaltd.com/out
    - yarn run static-ondrejsikaltd.com
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ondrejsikaltd.com/**/*
      - yarn.lock
  artifacts:
    name: ondrejsikaltd.com
    paths:
      - packages/ondrejsikaltd.com/out


ondrejsikaltd.com build docker:
  dependencies:
    - ondrejsikaltd.com build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/ondrejsikaltd.com/
    - docker build -t registry.sikahq.com/www/www/ondrejsikaltd.com:$CI_COMMIT_SHORT_SHA packages/ondrejsikaltd.com
    - rm packages/ondrejsikaltd.com/Dockerfile
    - rm packages/ondrejsikaltd.com/nginx-site.conf
    - docker push registry.sikahq.com/www/www/ondrejsikaltd.com:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ondrejsikaltd.com/**/*
      - yarn.lock

skoleni.io build js:
  stage: build_js_priority
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/skoleni.io/out
    - yarn run static-skoleni.io
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni.io/**/*
      - yarn.lock
  artifacts:
    name: skoleni.io
    paths:
      - packages/skoleni.io/out


skoleni.io build docker:
  dependencies:
    - skoleni.io build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker_priority
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/skoleni.io/
    - docker build -t registry.sikahq.com/www/www/skoleni.io:$CI_COMMIT_SHORT_SHA packages/skoleni.io
    - rm packages/skoleni.io/Dockerfile
    - rm packages/skoleni.io/nginx-site.conf
    - docker push registry.sikahq.com/www/www/skoleni.io:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/skoleni.io/**/*
      - yarn.lock

ondrejsika.is build js:
  stage: build_js
  image: node
  variables:
    GIT_CLEAN_FLAGS: none
  script:
    - yarn
    - rm -rf packages/ondrejsika.is/out
    - yarn run static-ondrejsika.is
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_JS
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/ondrejsika-theme/**/*
      - packages/ondrejsika.is/**/*
      - yarn.lock
      - packages/ondrejsika-singlepage/**/*
  artifacts:
    name: ondrejsika.is
    paths:
      - packages/ondrejsika.is/out


ondrejsika.is build docker:
  dependencies:
    - ondrejsika.is build js
  variables:
    GIT_STRATEGY: none
  stage: build_docker
  script:
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cp ci/docker/* packages/ondrejsika.is/
    - docker build -t registry.sikahq.com/www/www/ondrejsika.is:$CI_COMMIT_SHORT_SHA packages/ondrejsika.is
    - rm packages/ondrejsika.is/Dockerfile
    - rm packages/ondrejsika.is/nginx-site.conf
    - docker push registry.sikahq.com/www/www/ondrejsika.is:$CI_COMMIT_SHORT_SHA
  except:
    variables:
      - $EXCEPT_BUILD
      - $EXCEPT_BUILD_DOCKER
  only:
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/ondrejsika-theme/**/*
      - packages/ondrejsika.is/**/*
      - yarn.lock
      - packages/ondrejsika-singlepage/**/*

ondrejsika.is prod deploy k8s:
  stage: deploy_prod
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: .kubeconfig
  script:
    - echo $KUBECONFIG_FILECONTENT | base64 --decode > .kubeconfig
    - helm repo add ondrejsika https://helm.oxs.cz
    - helm upgrade --install ondrejsika-is ondrejsika/one-image --set host=ondrejsika.is --set image=$CI_REGISTRY_IMAGE/ondrejsika.is:$CI_COMMIT_SHORT_SHA --set changeCause=job-$CI_JOB_ID
    - kubectl rollout status deploy ondrejsika-is
  except:
    variables:
      - $EXCEPT_DEPLOY
      - $EXCEPT_DEPLOY_K8S
      - $EXCEPT_DEPLOY_PROD
      - $EXCEPT_DEPLOY_PROD_K8S
  only:
    refs:
      - master
    changes:
      - packages/data/**/*
      - packages/common/**/*
      - packages/course-landing/**/*
      - packages/ondrejsika.is/**/*
      - yarn.lock
  environment:
    name: prod ondrejsika.is
    url: https://ondrejsika.is
  dependencies: []
